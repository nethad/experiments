<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" type="text/css" href="minimal.css">
    <script src="http://opentabs.net:9000/socket.io/socket.io.js"></script>
    <script src="tabs.js"></script>
    <script src="msg.js"></script>
    <script src="users.js"></script>
    <script src="controller.js"></script>
    <script>
      function renderContact(obj) {
        return '<div id="summary" class="summary">'
          +'  <div class="avatar">'
          +'    <img src="'+obj.avatar+'">'
          +'  </div>'
          +'  <div>'
          +'    '+obj.name
          +'  </div>'
          +'  <br>'
          +'  <div class="contactButtons" id="contactButtons'+obj.contactId+'">'
          +'      <input type="submit" value="borrow" onclick="borrowA('+obj.contactId+');">'
          +'      <input type="submit" value="lend" onclick="lendA('+obj.contactId+');">'
          +'  </div>'
          +'  <form class="contactDialog" id="borrowDialog'+obj.contactId+'">'
          +'    <input id="borrowInput'+obj.contactId+'">'
          +'    <input type="submit" value="Borrow" class="borrowButton" onclick="borrowB('+obj.contactId+');">'
          +'    <input type="submit" value="x" class="cancelButton" onclick="cancelBB('+obj.contactId+');">'
          +'  </form>'
          +'  <form class="contactDialog" id="lendDialog'+obj.contactId+'">'
          +'    <input id="lendInput'+obj.contactId+'">'
          +'    <input type="submit" value="Lend" class="lendButton" onclick="lendB('+obj.contactId+');">'
          +'    <input type="submit" value="x" class="cancelButton" onclick="cancelLB('+obj.contactId+');">'
          +'  </form>'
          +'</div>';
        //dead code:
        var tabLists = makeTabLists(contacts[i].tabs);
        if(tabLists.notif.length) {
           var notifs = '<div class="notifList"><h4>Notif:</h4><ul>';
          for(var j in tabLists.notif) {
            notifs += '<li>'+tabLists.notif[j].icon+tabLists.notif[j].description+'</li>';
          }
          li.innerHTML += notifs+'</ul></div>';
        }
        if(tabLists.track.length) {
           var tracks = '<div class="trackList"><h4>Track:</h4><ul>';
          for(var j in tabLists.track) {
            tracks += '<li>'+tabLists.track[j].icon+tabLists.track[j].description+'</li>';
          }
          li.innerHTML += tracks+'</ul></div>';
        }
        return '<h2>'+obj.name+'</h2>';
      }
      function updateView(userAddress, obj) {
        if(document.getElementById('contact'+userAddress)) {
          document.getElementById('contact'+userAddress).innerHTML=
            renderContact(obj);
        } else {
          var div = document.createElement('div');
          div.innerHTML=
            renderContact(obj);
          document.getElementById('contacts').appendChild(div);
        }
      }
      function onBodyLoad() {
        controller.setCallbacks({
          onSecretErr: function(data) {
            alert('wrong!');
            localStorage.removeItem('secret');
            document.getElementById('secret').value='';
          },
          onSecretOK: function(data) {
            controller.getCharacters(function(characters) {
              var str = '<table><tr>';
              for(var i in characters) {
                str += '<td onclick="enter(\''
                  +characters[i].userAddress+'\');"><div class="avatarBig"><img src="'
                  +characters[i].avatar+'"><br><h2>'
                  +characters[i].name+'</h2></div></td>';
              }
              document.getElementById('characters').innerHTML= str+'</tr></table>';
            });
            document.getElementById('secretForm').style.display='none';
            if(localStorage.userAddress) {
              controller.setUserAddress(localStorage.userAddress,
                localStorage.secret);
            } else {
              document.getElementById('charactersForm').style.display='block';
            }
          },
          onErr: function(data) {
            alert('disconnected!');
            localStorage.removeItem('userAddress');
            document.getElementById('charactersForm').style.display='block';
          },
          onWelcome: function(data) {
            //document.getElementById('secretForm').style.display='none';
            document.getElementById('charactersForm').style.display='none';
            document.getElementById('mainView').style.display='block';
          }
        });
        controller.init(updateView);
        if(localStorage.secret) {
          controller.testSecret(localStorage.secret);
        }
      }
      function showSettings() {
        document.getElementById('settings').innerHTML = 
          '<div onclick="hideSettings();">Logged in as:<br>'
            +localStorage.userAddress+'</div>';
        document.getElementById('settings').style.display='block';
        document.getElementById('settingsIcon').style.display='none';
      }
      function hideSettings() {
        document.getElementById('settings').style.display='none';
        document.getElementById('settingsIcon').style.display='block';
      }
      function submitReset(e) {
        e.preventDefault();
        localStorage.clear();
        window.location='';
      }
      function submitSecret(e) {
        e.preventDefault();
        var secret = document.getElementById('secret').value;
        localStorage.setItem('secret', secret);
        controller.testSecret(secret);
      }
      function enter(nick) {
        var userAddress = nick+'@opentabs.net';
        localStorage.setItem('userAddress', userAddress);
        controller.setUserAddress(userAddress, localStorage.secret);
      }
    </script>
  </head>
  <body onload="onBodyLoad();">
    <div class="feedbackBar" id="feedbackBar">
      <input type="submit" value="reset" onclick="submitReset(event);">
    </div>
    <div class="secretForm" id="secretForm">
      Our secret word:
      <input id="secret">
      <input type="submit" onclick="submitSecret(event);">
    </div>
    <div class="charactersForm" id="charactersForm">
      Let's get into character:
      <div id="characters">
      </div>
    </div>
    <div class="mainView" id="mainView">
      <header>
        <span>
          Search/add:<input>
        </span>
        <span class="settings" id="settings">
        </span>
        <div class="settingsIcon" id="settingsIcon" onclick="showSettings();">
          <h2>*</h2>
        </div>
      </header>
      <div class="contacts" id="contacts">
      </div>
    </div>
  </body>
</html>
