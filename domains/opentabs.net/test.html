<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Opentabs.net app</title>
    <link rel="stylesheet" type="text/css" href="app.css">
    <script src="http://unhosted.org/remoteStorage.js"></script>
    <script src="IOU.js"></script>
  <script>
    var you='michiel@unhosted.org';

    function calcSignature(digest, keyPair) {
      return "yours truly";
    }
    function sha1(orig) {
      return 'sha1-asdfasdfasdfasdf';
    }

    function createTab(payer, payee, amount, currency, timestamp, otherFields, keyPair) {
      var obj = {
        payer: payer,
        payee: payee,
        status: 'proposed',
        amount: amount,
	currency: currency};
      obj.statement = "At timestamp "+timestamp+", "+payer+" starts owing "+payee+" an additional "+amount+" "+currency;
      obj.signatures = {};
      obj.signatures[keyPair.userAddress] = calcSignature(obj.statement, keyPair);
      for(var fieldName in otherFields) {
        obj[fieldName] = otherFields[fieldName];
      }
      return obj;
    }
    function el(el) {
      return document.getElementById(el);
    }
    function val(el) {
      try {
        return document.getElementById(el).value;
      } catch(e) {
        alert(JSON.stringify(e));
      }
    }
    function switchDirection() {
      if(val('direction')=='Owed by') {
        document.getElementById('direction').value='Owed to';
      } else {
        document.getElementById('direction').value='Owed by';
      }
    }
    function addContact(userAddress) {
      var contacts = remoteStorage.getItem('contacts');
      if(contacts == null) {
        contacts = '[]';
      }
      contacts = JSON.parse(contacts);
      for(var i in contacts) {
        if(contacts[i]==userAddress) {
          return i;
        }
      }
      contacts.push(userAddress);
      contacts = JSON.stringify(contacts);
      remoteStorage.setItem('contacts', contacts);
      return (contacts.length - 1);
    }
    function owe(i) {
      var peer = el('contact'+i).innerHTML;
      if(i==-1) {
        peer = el('contact'+i).value;//inputs use .value instead of .innerHTML
        if(peer=='') {
          alert('please enter the user address of the person you want to open a tab with');
          return;
        } else {
          var newIndex = addContact(peer);
          document.getElementById('contactsDiv').innerHTML = getContactsString();
          //this doesn't update on time: FIXME 
          //owe(newIndex);
          return;
        }
      }
      timestamp = (new Date().getTime());
      document.getElementById(i).innerHTML += 
         '<div>'
          +'<div style="border-style:solid;border-width::1px">'
          +'<input id="description'+i+'" value="Fahrkarte"> '
          +'<input size="3" id="amount'+i+'" value="40"> '
          +'<input type="submit" id="currency'+i+'" value="EUR"></span>'
          +'</div>'
          +'<div style="border-style:solid;border-width::1px">'
          +'<input type="submit" value="Owed to" id="direction" onclick="switchDirection();"> '
          +'<span>'+peer+'</span> '
          +'</div>'
          +'<div style="border-style:solid;border-width::1px">'
          +'<span><input type="submit" value="Cancel" onclick="cancel('+i+');"> '
          +'<input type="submit" value="Send" onclick="send('+i+');"></span>'
          +'</div>'
        +'</div>';
    }

    function cancel(i) {
      document.getElementById('contactsDiv').innerHTML = getContactsString();
    }
    function send(i) {
      var payer, payee;
      if(val('direction')=='Owed by') {
        payer=el('contact'+i).innerHTML;
        payee=you;
      } else {
        payer=you;
        payee=el('contact'+i).innerHTML;
      }
      sign(payer, payee, i);
    }
    function sign(payer, payee, i) {
      var keyPair = {n: 1, d:1, p:1, q:1, userAddress:'mich@unhosted.org'};
      var tab = createTab(payer, payee, val('amount'+i), val('currency'+i), timestamp,
        {
          description: val('description'+i),
          location: 'Berlin'
        },
	keyPair);
      storeTab(tab);
    }
    function storeTab(tab) {
      var tabs = JSON.parse(remoteStorage.getItem('tabs'));
      if(tabs == null) {
        tabs = [];
      }
      tabs.push(tab);   
      remoteStorage.setItem('tabs', JSON.stringify(tabs));
      cancel(i);
    }
    function addNewTab() {
      document.getElementById('-1').innerHTML= ''
        +'<input id="contact-1" placeholder="user@host">'
        +'<input type="submit" value="+" onclick="owe(-1);">';
    }
    function bodyonload() {
      document.getElementById('importantDiv').innerHTML = getImportantString();
      document.getElementById('contactsDiv').innerHTML = getContactsString();
      document.getElementById('historyDiv').innerHTML = getHistoryString();
    }
    function fakeIncoming(i) {
      timestamp = (new Date().getTime());
      var keyPair = {n: 1, d:1, p:1, q:1, userAddress:'jan@unhosted.org'};
      var tab = createTab('michiel@unhosted.org', 'jan@unhosted.org', 1, 'beer', timestamp, {}, keyPair);
      storeTab(tab);
      bodyonload();
    }
  </script>
  </head>
  <body onload="bodyonload();">
    <div style="border-style:dotted;border-width:5px">
      Fake events: <input type="submit" value="incoming IOU" onclick="fakeIncoming(1);">
    </div>
    <h2 style="display:none">Important</h2>
    <div id="importantDiv"></div>
    
    <div id="-1"><input type="submit" value="Open a Tab" onclick="addNewTab();"></div>

    <div id="contactsDiv"></div>
    
    <h2 style="display:none">History</h2>
    <div id="historyDiv"></div>
    
  </body>
</html>

