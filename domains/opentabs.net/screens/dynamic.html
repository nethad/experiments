<!DOCTYPE html>
<html lang="en">
<head>
  <title>Opentabs.net wire frames</title>
  <meta charset="utf8">
  <link rel="stylesheet" type="text/css" href="minimal.css">
  <script>
       /////////////
      // backend //
     /////////////
     var opentabs = (function() {
       function generateAlphaIdentities() {
         var contacts = [
          { name: 'Zed' },
          { name: 'Vincent' },
          { name: 'Fabienne'},
          { name: 'Wolf' },
          { name: 'Jules' },
          { name: 'Marcellus' },
          { name: 'Mia' },
        ];
        for(var i in contacts) {
          contacts[i].avatar = 'http://opentabs.net/screens/avatars/'
            +contacts[i].name.toLowerCase();
          contacts[i].userAddress = contacts[i].name.toLowerCase()+'@opentabs.net';
          contacts[i].tabs = [];
	}
        return contacts;
      }
      function setContacts(contacts) {
        localStorage.contacts = JSON.stringify(contacts);
      }
      function getContacts(filter) {
        if(!localStorage.contacts) {
          setContacts(generateAlphaIdentities());
        }
	var contacts = JSON.parse(localStorage.contacts);
        if(filter && filter.length) {
	  var filtered = {};
          for(var i in contacts) {
            var prefix = contacts[i].name.substring(0, filter.length);
            if(prefix.toLowerCase() == filter.toLowerCase()) {
              filtered[i]=contacts[i];
            }
          }
	  return filtered;
        } else {
          //return contacts;
	  var filtered = {};
          for(var i in contacts) {
            filtered[i]=contacts[i];
	  }
	  return filtered;
        }
      }
      function getMe() {
        return {
          name: 'Butch',
          userAddress: 'butch@opentabs.net',
          avatar: 'http://opentabs.net/screens/avatars/butch'
        }
      }
      function getContact(contactId) {
	var contacts = getContacts();
        return contacts[contactId];
      }
      function addTab(contactId, tab) {
	var contacts = getContacts();
        contacts[contactId].tabs.push(tab);
        setContacts(contacts);
      }
      function sendTab(contactId, type, description) {
        var tab = {};
        if(type == 'borrow') {
          tab.payee = getContact(contactId).userName;
          tab.payer = getMe().userName;
        } else {
          tab.payer = getContact(contactId).userName;
          tab.payee = getMe().userName;
        }
        tab.description = description;
        tab.timestamp = (new Date().getTime());
	var me = getMe().userAddress;
        tab.signatures = {me: 'yours truly'};
        addTab(contactId, tab);
      }
      return {
        getContacts: getContacts,
        sendTab: sendTab
      }
    })();

       //////////////
      // frontend //
     //////////////
    function borrowA(i) {
      document.getElementById('contactButtons'+i).style.display='none';
      document.getElementById('borrowDialog'+i).style.display='block';
      document.getElementById('borrowInput'+i).focus();
    }
    function lendA(i) {
      document.getElementById('contactButtons'+i).style.display='none';
      document.getElementById('lendDialog'+i).style.display='block';
      document.getElementById('lendInput'+i).focus();
    }
    function cancelBB(i) {
      document.getElementById('contactButtons'+i).style.display='block';
      document.getElementById('borrowDialog'+i).style.display='none';
    }
    function cancelLB(i) {
      document.getElementById('contactButtons'+i).style.display='block';
      document.getElementById('lendDialog'+i).style.display='none';
    }
    function borrowB(i) {
      document.getElementById('contactButtons'+i).style.display='block';
      document.getElementById('borrowDialog'+i).style.display='none';
      opentabs.sendTab(i, 'borrow', document.getElementById('borrowInput'+i).value);
      showContacts();
    }
    function lendB(i) {
      document.getElementById('contactButtons'+i).style.display='block';
      document.getElementById('lendDialog'+i).style.display='none';
      opentabs.sendTab(i, 'lend', document.getElementById('lendInput'+i).value);
      showContacts();
    }
    function makeTabLists(tabs) {
      return {notif: tabs}
    }
    function showContacts(filter) {
      var contacts = opentabs.getContacts(filter);
      document.getElementById('contacts').innerHTML='';
      for(var i in contacts) {
        var li = document.createElement('li');
        li.setAttribute('class', 'contact');
        li.innerHTML=
          '<div id="summary" class="summary">'
          +'  <div class="avatar">'
          +'    <img src="'+contacts[i].avatar+'">'
          +'  </div>'
          +'  <div>'
	  +'    '+contacts[i].name
          +'  </div>'
          +'  <br>'
          +'  <div class="contactButtons" id="contactButtons'+i+'">'
          +'      <input type="submit" value="borrow" onclick="borrowA('+i+');">'
          +'      <input type="submit" value="lend" onclick="lendA('+i+');">'
          +'  </div>'
          +'  <div class="contactDialog" id="borrowDialog'+i+'">'
          +'    <input id="borrowInput'+i+'">'
          +'    <input type="submit" value="Borrow" class="borrowButton" onclick="borrowB('+i+');">'
          +'    <input type="submit" value="x" class="cancelButton" onclick="cancelBB('+i+');">'
          +'  </div>'
          +'  <div class="contactDialog" id="lendDialog'+i+'">'
          +'    <input id="lendInput'+i+'">'
          +'    <input type="submit" value="Lend" class="lendButton" onclick="lendB('+i+');">'
          +'    <input type="submit" value="x" class="cancelButton" onclick="cancelLB('+i+');">'
          +'  </div>'
          +'</div>';
        var tabLists = makeTabLists(contacts[i].tabs);
	if(tabLists.notif) {
	  var notifs = '<div><ul>';
          for(var j in tabLists.notif) {
            notifs += '<li>'+tabLists.notif[j].description+'</li>';
	  }
	  li.innerHTML += notifs+'</ul></div>';
	}
        document.getElementById('contacts').appendChild(li);
      }
    }
    function bodyOnLoad() {
      showContacts();
    }
  </script>
</head>
<body onload="bodyOnLoad();">
<div class="main">
<article class="mainView">
  <header>
    <div class="searchBoxA">
      Search/add:
      <input size="3" onkeyup="showContacts(this.value);">
    </div>
  </header>
  <ul class="contacts" id="contacts">
  </ul>
</article>
</div>
</body>
</html>
