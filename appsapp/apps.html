<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title></title>
    <script src="/unhosted/sha1.js"></script>
    <script src="/unhosted/syncer.js"></script>
    <script>
      var apps;
      function displayList() {
        try {
          if(!apps) {
            apps = JSON.parse(localStorage['public$appList']);
          }
          if(!apps) {
            apps = {};
          }
          document.getElementById('apps').innerHTML = '';
          for(var i in apps) {
            var li = document.createElement('li');
            li.innerHTML=i
              +'<input type="submit" value="launch" onclick="launchApp(\''+i+'\');">'
              +'<input type="submit" value="edit" onclick="editApp(\''+i+'\');">'
              +'<input type="submit" value="-" onclick="removeApp(\''+i+'\');">';
            document.getElementById('apps').appendChild(li);
          }
        }catch(e){
        }
      }
      function removeApp(userAddress) {
        if(!apps) {
          apps = JSON.parse(localStorage['public$appList']);
        }
        delete apps[userAddress];
        localStorage['public$appList'] = JSON.stringify(apps);
        displayList();
      }
      syncer.onReadyStateChange(function(signedin, online, ready) {
        console.log((signedin?'signedin; ':'')+(online?'online; ':'')+(ready?'ready; ':''));
      });
      function addApp() {
        if(!apps) {
          apps = JSON.parse(localStorage['public$appList']);
        }
        if(!apps) {
          apps = {};
        }
        var hash = saveApp();
        apps[hash] = true;
        localStorage['public$appList'] = JSON.stringify(apps);
        displayList();
      }
      function connect() {
        syncer.connect(document.getElementById('userAddress').value, ['apps'], syncer.startSync);
      };
      function saveApp() {
        var objStr = JSON.stringify({
          css: document.getElementById('css').value,
          js: document.getElementById('js').value,
          html: document.getElementById('html').value
        });
        var hash = SHA1(objStr);
        localStorage['public$app:'+hash] = objStr;
        return hash;
      }
      function editApp(hash) {
        var obj = JSON.parse(localStorage['public$app:'+hash]);
        document.getElementById('css').value = obj.css;
        document.getElementById('js').value = obj.js;
        document.getElementById('html').value = obj.html;
      }
      function launchApp(hash) {
        window.open('http://'+hash+'.apptorrent.net/#peer='+encodeURIComponent(document.getElementById('userAddress').value));
      }
    </script>
  </head>
  <body onload="displayList();">
    <div>
      Account:
      <input id="userAddress" placeholder="user address">
      <input type="submit" value="connect" onclick="connect();">
      <div id="status"></div>
    </div>
    <div>
      Your Apps:
      <ul id="apps">
      </ul>
      <div>
        Source code:
        <input type="submit" onclick="addApp();" value="Save">
        <h2>HTML:</h2>
        <textarea id="html" style="width:50em;"></textarea>
        <h2>JS:</h2>
        <textarea id="js" style="width:50em;"></textarea>
        <h2>CSS:</h2>
        <textarea id="css" style="width:50em;"></textarea>
      </div>
    </div>
  </body>
</html>
