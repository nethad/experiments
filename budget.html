<html>
  <!-- this file is free software -->
  <head>
    <script>
      function genBudgets() {
        var ftVolBudgetBerlin = {
          live: 1000,
          health: 150,
          desk: 150,
          tax: 50
        };
        var orgBudget = {
          hosting: 1000,
          travAccConf: 1000,
          compCampPub: 500
        };
        var budgets = {};
        for(var i=0; i<12; i++) {
          budgets[i] = {
            liveMich: ftVolBudgetBerlin.live,
            liveJan: ftVolBudgetBerlin.live,
            healthMich: ftVolBudgetBerlin.health,
            healthJan: ftVolBudgetBerlin.health,
            deskMich: ftVolBudgetBerlin.desk,
            deskJan: ftVolBudgetBerlin.desk,
            taxMich: ftVolBudgetBerlin.tax,
            taxJan: ftVolBudgetBerlin.tax,
            hosting: orgBudget.hosting / 12,
            travAccConf: orgBudget.travAccConf / 12,
            compCampPub: orgBudget.compCampPub / 12
          }
        }
        budgets[0].unhosted = 4613.82;
        return budgets;
      }
      function getDeclarations() {
        var declarations = [
          {ower: 'berlinerbank', owee: 'budget', month: 0, note: 'donations received from crowd funding campaign', amount: 153.62},
          {ower: 'paypal', owee: 'budget', month: 0, note: 'donations received from crowd funding campaign', amount: 4042},
          {ower: 'paypal', owee: 'budget', month: 5, note: 'various donations received through flattr and paypal', amount: 690},
          {ower: 'paypal', owee: 'budget', month: 6, note: 'donation received from DuckDuckGo', amount: 740},
          {ower: 'nlnet', owee: 'budget', month: 1, note: 'donation linked to milestone A', amount: 5000},
          {ower: 'nlnet', owee: 'budget', month: 3, note: 'donation linked to milestone B', amount: 5000},
          {ower: 'nlnet', owee: 'budget', month: 5, note: 'donation linked to milestone C', amount: 5000},
          {ower: 'nlnet', owee: 'budget', month: 7, note: 'donation linked to milestone D', amount: 5000},
          {ower: 'nlnet', owee: 'budget', month: 9, note: 'donation linked to milestone E', amount: 5000},
          {ower: 'nlnet', owee: 'budget', month: 11, note: 'donation linked to milestone F', amount: 5000},
          {ower: 'compCampPub', owee: 'michiel', amount: 35, month: 0, note: '42 Unhost postcards to send with T-shirts (via Kenny): 42 * 20 CZK = 840 CZ'},
          {ower: 'compCampPub', owee: 'michiel', amount: 80, month: 0, note: 'stamps for sending 27 T-shirt packages from Unhost: 1950 CZK'},
          {ower: 'compCampPub', owee: 'michiel', amount: 44.30, month: 0, note: 'sending another 14 T-shirts: 2x Germany(1.45 EUR), 12x international(3.45 EUR)'},
          {ower: 'deskMich', owee: 'berlinerbank', month: 0, note: 'days co-up Michiel sept', amount: 95},
          {ower: 'unhosted', owee: 'michiel', month: 0, note: 'year one expenses excl. Krankenkasse Michiel', amount: 4613.82},
          {ower: 'michiel', owee: 'paypal', month: 0, note: 'transaction to comdirect', amount: 4042},
          {ower: 'compCampPub', owee: 'michiel', month: 0, note: 'sdw prints', amount: 4.50},
          {ower: 'compCampPub', owee: 'michiel', month: 0, note: 'sdw (TODO: check exact amount)', amount: 130},
          {ower: 'compCampPub', owee: 'michiel', month: 0, note: 'sending T-shirts (3rd batch)', amount: 40.15},
          {ower: 'travAccConf', owee: 'michiel', month: 0, note: 'paid 185,75 in train tickets, of which 89,25 will be paid back through Jan, and 38,50 is a donation from Michiel to DS11', amount: 185.75-89.25-38.50},
          {ower: 'jan', owee: 'michiel', month: 0, note: 'paid 185,75 in train tickets, of which 89,25 will be paid back through Jan, and 38,50 is a donation from Michiel to DS11', amount: 89.25},
          {ower: 'hosting', owee: 'michiel', month: 0, note: '5-9-2011 28-9-2011 (Liquidado) Pago en GODADDY.COM EUROPE 02079792661', amount: 19.73},
          {ower: 'hosting', owee: 'michiel', month: 0, note: 'TODO: check why there are two payments with the same concept here', amount: 12.43},
          {ower: 'travAccConf', owee: 'michiel', month: 0, note: '9-9-2011 28-9-2011 (Liquidado) Pago en T-MOBILE CZECH REPUBLIK BONN', amount: 24.59},
          {ower: 'hosting', owee: 'michiel', month: 1, note: '03/10/2011 THE RACKSPACE CLOUD (210-581-0410 - Estados Unidos)', amount: 20.28},
          {ower: 'hosting', owee: 'michiel', month: 1, note: '20/10/2011 GODADDY.COM EUROPE (02079792661 - Reino Unido)', amount: 7.50},
          {ower: 'michiel', owee: 'nlnet', month: 2, note: 'received bank transfer', amount: 2800},
          {ower: 'travAccConf', owee: 'michiel', month: 2, note: 'mozfest (apart from travel to UK which was already in there)', amount: 32.76},
          {ower: 'surfnet', owee: 'michiel', month: 2, note: 'visit to surfnet was 12+9+2 = 21 eur by train', amount: 21},
          {ower: 'travAccConf', owee: 'michiel', month: 2, note: 'train govcert -> bearstech', amount: 47},
          {ower: 'hosting', owee: 'michiel', month: 2, note: 'rackspace 2 nov', amount: 20.69},
          {ower: 'hosting', owee: 'michiel', month: 3, note: 'rackspace 2 dec', amount: 23.91},
          {ower: 'michiel', owee: 'nlnet', month: 4, note: 'received bank transfer', amount: 2500},
          {ower: 'healthMich', owee: 'michiel', month: 4, note: 'zekur health insurance (10-11-2011..29-02-2012)', amount: 265.15},
          {ower: 'hosting', owee: 'michiel', month: 4, note: 'rackspace 3 jan', amount: 19.12},
          {ower: 'travAccConf', owee: 'michiel', month: 5, note: 'hostal FOSDEM', amount: 58.50},
          {ower: 'travAccConf', owee: 'michiel', month: 5, note: 'tram in Brussels 2+2+3.50', amount: 2+2+3.50},
          {ower: 'travAccConf', owee: 'michiel', month: 5, note: 'train BXL->NL', amount: 35.70},
          {ower: 'surfnet', owee: 'michiel', month: 5, note: 'train+bus Terena 8+2', amount:8+2},
          {ower: 'surfnet', owee: 'michiel', month: 5, note: 'train -> Deventer', amount: 15.80},
          {ower: 'surfnet', owee: 'michiel', month: 5, note: 'train+bus Deventer -> Den Haag', amount: 15.20+2},
          
          {ower: 'michiel', owee: 'nlnet', month: 6, note: 'received bank transfer 3 Mar', amount: 2000},
          {ower: 'michiel', owee: 'paypal', month: 5, note: 'received bank transfer -> comdirect 17 feb', amount: 740},
          {ower: 'michiel', owee: 'paypal', month: 6, note: 'received bank transfer -> comdirect 8 mar', amount: 690},
          {ower: 'hosting', owee: 'michiel', month: 5, note: 'rackspace 3 feb', amount: 11.07},
          {ower: 'hosting', owee: 'michiel', month: 5, note: '29/02/2012  Pendiente de liquidar   Pago en GODADDY.COM EUROPE 02079792661', amount: 11.44},
          {ower: 'hosting', owee: 'michiel', month: 5, note: '03/03/2012  Pendiente de liquidar   Pago en THE RACKSPACE CLOUD 210-581-0410', amount: 11.63},
          {ower: 'nlnet', owee: 'michiel', month: 5, note: '12/03/2012  Pendiente de liquidar   Pago en VUELING AIRLINES EL PRAT DE LL', amount: 79.49},
          
          {ower: 'jan', owee: 'nlnet', month: 2, note: 'received bank transfer 2 Nov', amount: 2200},
          {ower: 'deskJan', owee: 'berlinerbank', month: 0, note: 'days co-up: 14,15 sept, 3 single tickets (paid through Berliner Bank)', amount: 36},
          {ower: 'travAccConf', owee: 'berlinerbank', month: 0, note: 'jsconfEU party Jan (paid through Berliner Bank)', amount: 22.62},
          {ower: 'compCampPub', owee: 'jan', month: 0, note: 'stickers', amount: 151.73},
          //{ower: 'jan', owee: 'travAccConf', month: 0, note: '188 € train: 169 to webtechcon + 19 back (paid by them)', amount: },
          {ower: 'compCampPub', owee: 'jan', month: 0, note: 'copyshop for 24 Unhost postcards', amount: 6.85},
          {ower: 'compCampPub', owee: 'jan', month: 2, note: 'stamps for 3 more shirts (November 10)', amount: 7.85},
          {ower: 'travAccConf', owee: 'jan', month: 2, note: '(1.80+2.80+2.80) in local tickets to get to HamburgJS, to friend and back (~90 in DB tickets paid by HamburgJS, November 21)', amount: 1.80+2.80+2.80},
          {ower: 'travAccConf', owee: 'jan', month: 2, note: 'day pass to get to Köpenick youth meeting (Facebook presentation, 100 € payment will be donated to Unhosted e. V., November 22)', amount: 6.30},
          {ower: 'travAccConf', owee: 'jan', month: 3, note: 'packages and stamps for sending more shirts (December 5)', amount: 4.54},
          {ower: 'travAccConf', owee: 'jan', month: 3, note: '28C3 day pass to give a lightning talk (December 30)', amount: 35},
          {ower: 'jan', owee: 'nlnet', month: 4, note: 'received bank transfer 2 Jan', amount: 2500},
          {ower: 'healthJan', owee: 'jan', month: 4, note: 'health insurance Jan (September–January, February 15)', amount: 1082.19},
          {ower: 'healthJan', owee: 'jan', month: 4, note: 'health insurance abroad Jan: 11.00 € (yearly fee)', amount: 11},
          
          {ower: 'healthJan', owee: 'jan', month: 4, note: 'liability insurance Jan: 69.59 € (yearly fee) TODO: add Mich\'s liability insurance too', amount: 69.59},
          {ower: 'jan', owee: 'nlnet', month: 6, note: 'received bank transfer 2 Mar', amount: 3000},
          {ower: 'compCampPub', owee: 'jan', month: 6, note: 'sending two shirts (March 7)', amount: 4.90},
          {ower: 'travAccConf', owee: 'jan', month: 6, note: 'bus tickets (5.00+2.70) getting into Amsterdam (hitchhiked there, March 7)', amount: 5+2.70},
          {ower: 'compCampPub', owee: 'jan', month: 6, note: 'printing Unhosted readers for Unlike Us conf attendees (March 9)', amount: 7.95},
          {ower: 'travAccConf', owee: 'jan', month: 6, note: '(3*2.70) getting to the Unlike Us conf venue (March 9–10)', amount: 3*2.70},
          {ower: 'travAccConf', owee: 'jan', month: 6, note: 'Unlike Us Amsterdam train back (March 11)', amount: 79},
          {ower: 'deskJan', owee: 'jan', month: 6, note: '10-day flex ticket Coworking0711 (March 15)', amount: 149},
          {ower: 'travAccConf', owee: 'jan', month: 6, note: '', amount: 3*2.70},
          {ower: 'healthJan', owee: 'jan', month: 6, note: 'health insurance feb (March 15)', amount: 221.15},
          {ower: 'compCampPub', owee: 'jan', month: 6, note: 'sending another shirt (March 17)', amount: 3.45},
          {ower: 'compCampPub', owee: 'jan', month: 6, note: 'one thousand new stickers from Flyeralarm (March 22)', amount: 54.61},
          {ower: 'healthJan', owee: 'jan', month: 7, note: 'health insurance mar (April 15)', amount: 221.15},
          {ower: 'healthJan', owee: 'jan', month: 8, note: 'health insurance apr (May 15)', amount: 221.15},
          {ower: 'healthJan', owee: 'jan', month: 9, note: 'health insurance may (June 15)', amount: 221.15},
          {ower: 'healthJan', owee: 'jan', month: 10, note: 'health insurance june (July 15)', amount: 221.15},
          {ower: 'healthJan', owee: 'jan', month: 11, note: 'health insurance july (Aug 15)', amount: 221.15},
          {ower: 'healthJan', owee: 'jan', month: 11, note: 'health insurance aug (Sep 15)', amount: 221.15}
          //0:sep 1:oct 2:nov 3:dec 4:jan 5:feb 6:mar 7:apr 
          //{ower: 'hosting', owee: 'michiel', month: 5, note: '', amount: },
        ];
        for(var i=0; i < 12; i++) {
          declarations.push({ower: 'liveMich', owee: 'michiel', month: i, note: 'living expenses Michiel (based on Berlin)', amount: 1000});
          declarations.push({ower: 'liveJan', owee: 'jan', month: i, note: 'living expenses Jan (based on '+(i>8?'living outside ':'')+'Berlin)', amount: (i>8?1500:1000)});
        }
        //predict nlnet payments:
        declarations.push({ower: 'michiel', owee: 'nlnet', month: 8, note: 'predicted payment milestone D', amount: 2000});
        declarations.push({ower: 'jan', owee: 'nlnet', month: 8, note: 'predicted payment milestone D', amount: 3000});
        declarations.push({ower: 'michiel', owee: 'nlnet', month: 10, note: 'predicted payment milestone E', amount: 2000});
        declarations.push({ower: 'jan', owee: 'nlnet', month: 10, note: 'predicted payment milestone E', amount: 3000});
        declarations.push({ower: 'michiel', owee: 'nlnet', month: 11, note: 'predicted payment milestone F', amount: 2000});
        declarations.push({ower: 'jan', owee: 'nlnet', month: 11, note: 'predicted payment milestone F', amount: 3000});
        return declarations;
      }
        
      var data = {};
      function simulateMessage(from, to, timestamp, msg) {
        if(!data[from]) {
          data[from] = {};
        }
        if(!data[to]) {
          data[to] = {};
        }
        while(data[from][timestamp]) {
          timestamp++;
        }
        data[from][timestamp]= {
          tags: ['sent'],
          msg: msg,
          from: from,
          to: to
        };
        while(data[to][timestamp]) {
          timestamp++;
        }
        data[to][timestamp]={
          tags: ['inbox'],
          msg: msg,
          from: from,
          to: to
        };
      }
      //gestures:
      //pledge: the original meaning of a delta IOU.
      //pledge-cond: for budgetting and contracting (e.g. conditional on handing in a relevant receipt, or completing a project to spec)
      //invoice: the owee requests for the ower to sign pledge.
      //receipt: the ower confirms having received money from the owee. this type of IOU is usually used to cancel out against one that represent the debt that was settled by the transfer.
      //balance: either party tells the other one how much they think they owe each other at that timestamp. note the very important difference between delta gestures and cumm gestures.
      //predict: purely informational; used for planning purposes only. the timestamp can be in the future.
      //budget: the ower tells the owee a maximum of how much they are willing to pay for a purpose if the owee (can prove that they) spent money for that purpose. the timestamp is the timestamp at which the budget is assigned, and start and end of the budget are part of the 'purpose', and also used by the budget giver and/or the budget receiver to send monthly 'predict' messages.

      //IOU fields always:
      // ower (<user@host>)
      // owee (<user@host>)
      // amount (<int>)
      // currency (<string>)
      // note (<string>)
      // timestamp (<timestamp>)
      // signatures {pledge:[<string>], receipt, invoice, balance, predict}

      //representing a budget assignment:
      // unique (['timestamp', 'cond'])
      // cond (<string>)
      // period ({start: <timestamp>, end: <timestamp>})
      // signatures {budget:[<string>]}

      //representing a claim on a budget:
      // unique (['goods'])
      // goods (<string>)
      // signatures {claim:[<string>]}

      //representing a receipt for a payment:
      // unique (['timestamp'])
      // signatures {received:[<string>]}

      //representing a receipt for purchased goods:
      // unique (['goods'])
      // goods (<string>)
      // signatures {owe:[<string>]}

      //representing an invoice:
      // unique (['goods'])
      // goods (<string>)
      // signatures {owe:[<string>]}


//events: 
//buy - to: amount: currency: goods:/unconditional budget-period:/timeless
//aval - to: amount: currency: goods:/unconditional budget-period:/timeless
//delivery goods/payment

//gestures:
//predict
//report

//interface:
//vrm: announce something you need and would pay for
//crm: announce something you would deliver if paid for
//back a project
//donate money unconditionally 
//invest in a project
//lend money
//borrow money
//define goods
//create a project
//promise to pay for goods you received
//invoice for goods you delivered
//report a payment

//contract types:
//sale (buy/sell)
//debt (borrow/lend)
//budget (back a project/rely on an angel)
//gift (donate/ask for donations)

//users: back a project: donate, guarantee, buy, lend.
//projects: ask for donations, ask for guarantees, sell, borrow.

      function simulateMessages() {
        var monthName = ['Sep11', 'Oct11', 'Nov11', 'Dec11', 'Jan12', 'Feb12', 'Mar12', 'Apr12', 'May12', 'Jun12', 'Jul12', 'Aug12'];
        var budgets = genBudgets();
        for(var i in budgets) {
          var monthStart = new Date('9 9 2011').getTime() + i * 2635200000;
          var monthEnd = new Date('9 9 2011').getTime() + (i+1) * 2635200000 - 1;
          for(var j in budgets[i]) {
            simulateMessage('budget@unhosted.org', j+'@unhosted.org', monthStart, JSON.stringify({
              subject: 'budget assignment',
              recipients: [j+'@unhosted.org'],
              body: 'The board of Unhosted e.V. hereby confirm that we have set the "'+j+'" budget for '+monthName[i]
              +' to '+budgets[i][j]+' euros. This doesn\'t mean we have to spend that money. '
              +'If we do spend this money, then we can use the attached IOU to route the payment. '
              +'If we spend more than the budget on '+j+' during that '+monthName[i]+', then we have to think why that was, and issue a separate decision with its '
              +'own IOU to route the money.',
              IOU: {
                ower: 'budget@unhosted.org',
                owee: j+'@unhosted.org',
                amount: budgets[i][j],
                currency: 'EUR',
                contract: 'budget',
                note: j+' budget for '+monthName[i],
                period: {
                  start: monthStart,
                  end: monthEnd
                },
                timestamp: monthStart,
                signatures: ['The general meeting of Unhosted e.V, in the #unhosted IRC channel on freenode, 9 September 2011.']
              }
            }));
          }
        }
        var declarations = getDeclarations();
        for(var i=0; i<declarations.length; i++) {
          var monthEnd = new Date('9 9 2011').getTime() + declarations[i].month * 2635200000;
          simulateMessage(declarations[i].owee+'@unhosted.org', declarations[i].ower+'@unhosted.org', monthEnd, JSON.stringify({
            subject: 'declaration',
            recipients: [declarations[i].ower+'@unhosted.org'],
            body: 'Please reimburse me ('+declarations[i].owee+') '
              +declarations[i].amount+' euros for the following costs I made in '
              +monthName[declarations[i].month]+':'
              +declarations[i].note,
            IOU: {
              ower: declarations[i].ower+'@unhosted.org',
              owee: declarations[i].owee+'@unhosted.org',
              amount: declarations[i].amount,
              currency: 'EUR',
              contract: 'sale',
              goods: declarations[i].note,
              timestamp: monthEnd,
              signatures: [declarations[i].owee+'@unhosted.org']
            }
          }));
        }
      }
      function displayTab(person) {
        var str = '</table>';
        var IOUs = {};
        var timestamps = [];
        //scan the person's messages for attached IOUs
        for(var i in data[person]) {
          var msg = JSON.parse(data[person][i].msg);
          if(msg.IOU) {
            IOUs[i]=msg.IOU;
            timestamps.push(i);
          }
        }
        timestamps.sort();
        var cumm=0, cumms = {}, minTime=new Date().getTime(), maxTime=new Date().getTime(), minVal = 0, maxVal = 0;
        for(var i=0; i<timestamps.length; i++) {
          if(IOUs[timestamps[i]].ower == person) {
            cumm += IOUs[timestamps[i]].amount;
            str = '<tr><td>'+IOUs[timestamps[i]].owee
              +'</td><td>'+IOUs[timestamps[i]].note
              +'</td><td>'+IOUs[timestamps[i]].amount
              +'</td><td>'+cumm
              +'</td></tr>'
              +str;
          } else if(IOUs[timestamps[i]].owee == person) {
            cumm -= IOUs[timestamps[i]].amount;
            str = '<tr><td>'+IOUs[timestamps[i]].ower
              +'</td><td>'+IOUs[timestamps[i]].note
              +'</td><td>'+(0-IOUs[timestamps[i]].amount)
              +'</td><td>'+cumm
              +'</td></tr>'
              +str;
          }
          cumms[i]=cumm;
          if(timestamps[i] < minTime) {
            minTime = timestamps[i];
          } else if(timestamps[i] > maxTime) {
            maxTime = timestamps[i];
          }
          if(cumm < minVal) {
            minVal = cumm;
          } else if(cumm > maxVal) {
            maxVal = cumm;
          }
        }
        var nowX = 500*(new Date().getTime()-minTime)/(maxTime-minTime);
        var graphStr = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1">'
          +'<polyline points="0,0 500,0" style="fill:none;stroke:black;stroke-width:1"/>'
          +'<polyline points="0,50 500,50" style="fill:none;stroke:black;stroke-width:1"/>'
          +'<polyline points="0,100 500,100" style="fill:none;stroke:black;stroke-width:1"/>'
          +'<polyline points="0,150 500,150" style="fill:none;stroke:black;stroke-width:3"/>'
          +'<polyline points="0,200 500,200" style="fill:none;stroke:black;stroke-width:1"/>'
          +'<polyline points="0,250 500,250" style="fill:none;stroke:black;stroke-width:1"/>'
          +'<polyline points="0,300 500,300" style="fill:none;stroke:black;stroke-width:1"/>'
          +'<polyline points="0,405 500,405" style="fill:none;stroke:black;stroke-width:1"/>'
          +'<polyline points="'+nowX+',0 '+nowX+',300" style="fill:none;stroke:black;stroke-width:3"/>'
          +'<polyline points="';
        for(var i=0; i<timestamps.length; i++) {
          var x = 500*(timestamps[i]-minTime)/(maxTime-minTime);
          var y = 250-150*(cumms[i]-minVal)/(maxVal-minVal);
          graphStr += ' '+x+','+y;
        }
        graphStr += '" style="fill:none;stroke:black;stroke-width:2" />'
          +'</svg>';

        str = graphStr + '<table border="1"><tr><td>peer</td><td>note</td><td>amount</td><td>cumm</td></tr>'+str;
        document.getElementById('output').innerHTML = str;
      }
      function onLoad() {
        simulateMessages();

        console.log(data);
        var str = '';
        for(var i in data) {
          str += '<a href="?#'+i+'" onclick="displayTab(\''+i+'\');">'+i+'</a>&nbsp;';
        }
        document.getElementById('navbar').innerHTML = str;
        if(location.hash.length) {
          displayTab(location.hash.substring(1));
        }
      }
    </script>
  </head>
  <body onload="onLoad();">
    <div id="navbar"></div>
    <div id="output"></div>
  </body>
</html>
