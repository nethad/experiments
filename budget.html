<html>
  <!-- this file is free software -->
  <head>
    <script>
      function genBudgets() {
        var ftVolBudgetBerlin = {
          live: 1000,
          health: 150,
          desk: 150,
          tax: 50
        };
        var ftVolBudgetStuttgart = {
          live: 1500,
          health: 150,
          desk: 25,
          tax: 75
        };
        var orgBudget = {
          hosting: 1000,
          travAccConf: 1000,
          compCampPub: 500
        };
        var budgets = {};
        for(var i=0; i<12; i++) {
          budgets[i] = {
            liveMich: ftVolBudgetBerlin.live,
            liveJan: ftVolBudgetBerlin.live,
            healthMich: ftVolBudgetBerlin.health,
            healthJan: ftVolBudgetBerlin.health,
            deskMich: ftVolBudgetBerlin.desk,
            deskJan: ftVolBudgetBerlin.desk,
            taxMich: ftVolBudgetBerlin.tax,
            taxJan: ftVolBudgetBerlin.tax,
            hosting: orgBudget.hosting / 12,
            travAccConf: orgBudget.travAccConf / 12,
            compCampPub: orgBudget.compCampPub / 12,
            unhosted: 0,
            berlinerbank: 0,
            paypal: 0,
            nlnet: 0,
            surfnet: 0,
            michiel: 0,
            jan: 0
          }
          //adopt for Jan living outside Berlin May, Jun, Jul, Aug:
          if (i >= 9) {
            budgets[i].liveJan = ftVolBudgetStuttgart.live;
            budgets[i].deskJan = ftVolBudgetStuttgart.desk;
            budgets[i].taxJan = ftVolBudgetStuttgart.tax;
          }
        }
        return budgets;
      }
      function getDeclarations() {
        var declarations = [
          {ower: 'paypal', owee: 'unhosted', month: 0, note: 'donations received from crowd funding campaign', amount: 4042},
          {ower: 'nlnet', owee: 'unhosted', month: 1, note: 'donatin linked to milestone A', amount: 5000},
          {ower: 'nlnet', owee: 'unhosted', month: 3, note: 'donatin linked to milestone B', amount: 5000},
          {ower: 'nlnet', owee: 'unhosted', month: 5, note: 'donatin linked to milestone C', amount: 5000},
          {ower: 'nlnet', owee: 'unhosted', month: 7, note: 'donatin linked to milestone D', amount: 5000},
          {ower: 'nlnet', owee: 'unhosted', month: 9, note: 'donatin linked to milestone E', amount: 5000},
          {ower: 'nlnet', owee: 'unhosted', month: 11, note: 'donatin linked to milestone F', amount: 5000},
          {ower: 'compCampPub', owee: 'michiel', amount: 35, month: 0, note: '42 Unhost postcards to send with T-shirts (via Kenny): 42 * 20 CZK = 840 CZ'},
          {ower: 'compCampPub', owee: 'michiel', amount: 80, month: 0, note: 'stamps for sending 27 T-shirt packages from Unhost: 1950 CZK'},
          {ower: 'compCampPub', owee: 'michiel', amount: 44.30, month: 0, note: 'sending another 14 T-shirts: 2x Germany(1.45 EUR), 12x international(3.45 EUR)'},
          {ower: 'deskMich', owee: 'berlinerbank', month: 0, note: 'days co-up Michiel sept', amount: 95},
          {ower: 'unhosted', owee: 'michiel', month: 0, note: 'year one expenses excl. Krankenkasse Michiel', amount: 4613.82},
          {ower: 'michiel', owee: 'paypal', month: 0, note: 'transaction to comdirect', amount: 4042},
          {ower: 'compCampPub', owee: 'michiel', month: 0, note: 'sdw prints', amount: 4.50},
          {ower: 'compCampPub', owee: 'michiel', month: 0, note: 'sdw (TODO: check exact amount)', amount: 130},
          {ower: 'compCampPub', owee: 'michiel', month: 0, note: 'sending T-shirts (3rd batch)', amount: 40.15},
          {ower: 'travAccConf', owee: 'michiel', month: 0, note: 'paid 185,75 in train tickets, of which 89,25 will be paid back through Jan, and 38,50 is a donation from Michiel to DS11', amount: 185.75-89.25-38.50},
          {ower: 'jan', owee: 'michiel', month: 0, note: 'paid 185,75 in train tickets, of which 89,25 will be paid back through Jan, and 38,50 is a donation from Michiel to DS11', amount: 89.25},
          {ower: 'hosting', owee: 'michiel', month: 0, note: '5-9-2011 28-9-2011 (Liquidado) Pago en GODADDY.COM EUROPE 02079792661', amount: 19.73},
          {ower: 'hosting', owee: 'michiel', month: 0, note: 'TODO: check why there are two payments with the same concept here', amount: 12.43},
          {ower: 'travAccConf', owee: 'michiel', month: 0, note: '9-9-2011 28-9-2011 (Liquidado) Pago en T-MOBILE CZECH REPUBLIK BONN', amount: 24.59},
          {ower: 'hosting', owee: 'michiel', month: 1, note: '03/10/2011 THE RACKSPACE CLOUD (210-581-0410 - Estados Unidos)', amount: 20.28},
          {ower: 'hosting', owee: 'michiel', month: 1, note: '20/10/2011 GODADDY.COM EUROPE (02079792661 - Reino Unido)', amount: 7.50},
          {ower: 'michiel', owee: 'nlnet', month: 2, note: 'received bank transfer', amount: 2800},
          {ower: 'travAccConf', owee: 'michiel', month: 2, note: 'mozfest (apart from travel to UK which was already in there)', amount: 32.76},
          {ower: 'surfnet', owee: 'michiel', month: 2, note: 'visit to surfnet was 12+9+2 = 21 eur by train', amount: 21},
          {ower: 'travAccConf', owee: 'michiel', month: 2, note: 'train govcert -> bearstech', amount: 47},
          {ower: 'hosting', owee: 'michiel', month: 2, note: 'rackspace 2 nov', amount: 20.69},
          {ower: 'hosting', owee: 'michiel', month: 3, note: 'rackspace 2 dec', amount: 23.91},
          {ower: 'michiel', owee: 'nlnet', month: 4, note: 'received bank transfer', amount: 2500},
          {ower: 'healthMich', owee: 'michiel', month: 4, note: 'zekur health insurance (10-11-2011..29-02-2012)', amount: 265.15},
          {ower: 'hosting', owee: 'michiel', month: 4, note: 'rackspace 3 jan', amount: 19.12},
          {ower: 'travAccConf', owee: 'michiel', month: 5, note: 'hostal FOSDEM', amount: 58.50},
          {ower: 'travAccConf', owee: 'michiel', month: 5, note: 'tram in Brussels 2+2+3.50', amount: 2+2+3.50},
          {ower: 'travAccConf', owee: 'michiel', month: 5, note: 'train BXL->NL', amount: 35.70},
          {ower: 'surfnet', owee: 'michiel', month: 5, note: 'train+bus Terena 8+2', amount:8+2},
          {ower: 'surfnet', owee: 'michiel', month: 5, note: 'train -> Deventer', amount: 15.80},
          {ower: 'surfnet', owee: 'michiel', month: 5, note: 'train+bus Deventer -> Den Haag', amount: 15.20+2},
          
          {ower: 'michiel', owee: 'nlnet', month: 6, note: 'received bank transfer 3 Mar', amount: 2000},
          {ower: 'michiel', owee: 'paypal', month: 5, note: 'received bank transfer -> comdirect 17 feb', amount: 740},
          {ower: 'michiel', owee: 'paypal', month: 6, note: 'received bank transfer -> comdirect 8 mar', amount: 690},
          {ower: 'hosting', owee: 'michiel', month: 5, note: 'rackspace 3 feb', amount: 11.07},
          {ower: 'hosting', owee: 'michiel', month: 5, note: '29/02/2012  Pendiente de liquidar   Pago en GODADDY.COM EUROPE 02079792661', amount: 11.44},
          {ower: 'hosting', owee: 'michiel', month: 5, note: '03/03/2012  Pendiente de liquidar   Pago en THE RACKSPACE CLOUD 210-581-0410', amount: 11.63},
          {ower: 'nlnet', owee: 'michiel', month: 5, note: '12/03/2012  Pendiente de liquidar   Pago en VUELING AIRLINES EL PRAT DE LL', amount: 79.49},
          
          {ower: 'jan', owee: 'nlnet', month: 2, note: 'received bank transfer 2 Nov', amount: 2200},
          {ower: 'deskJan', owee: 'berlinerbank', month: 0, note: 'days co-up: 14,15 sept, 3 single tickets (paid through Berliner Bank)', amount: 36},
          {ower: 'travAccConf', owee: 'berlinerbank', month: 0, note: 'jsconfEU party Jan (paid through Berliner Bank)', amount: 22.62},
          {ower: 'compCampPub', owee: 'jan', month: 0, note: 'stickers', amount: 151.73},
          //{ower: 'jan', owee: 'travAccConf', month: 0, note: '188 € train: 169 to webtechcon + 19 back (paid by them)', amount: },
          {ower: 'compCampPub', owee: 'jan', month: 0, note: 'copyshop for 24 Unhost postcards', amount: 6.85},
          {ower: 'compCampPub', owee: 'jan', month: 2, note: 'stamps for 3 more shirts (November 10)', amount: 7.85},
          {ower: 'travAccConf', owee: 'jan', month: 2, note: '(1.80+2.80+2.80) in local tickets to get to HamburgJS, to friend and back (~90 in DB tickets paid by HamburgJS, November 21)', amount: 1.80+2.80+2.80},
          {ower: 'travAccConf', owee: 'jan', month: 2, note: 'day pass to get to Köpenick youth meeting (Facebook presentation, 100 € payment will be donated to Unhosted e. V., November 22)', amount: 6.30},
          {ower: 'travAccConf', owee: 'jan', month: 3, note: 'packages and stamps for sending more shirts (December 5)', amount: 4.54},
          {ower: 'travAccConf', owee: 'jan', month: 3, note: '28C3 day pass to give a lightning talk (December 30)', amount: 35},
          {ower: 'jan', owee: 'nlnet', month: 4, note: 'received bank transfer 2 Jan', amount: 2500},
          {ower: 'healthJan', owee: 'jan', month: 4, note: 'health insurance Jan (September–January, February 15)', amount: 1082.19},
          {ower: 'healthJan', owee: 'jan', month: 4, note: 'health insurance abroad Jan: 11.00 € (yearly fee)', amount: 11},
          
          {ower: 'healthJan', owee: 'jan', month: 4, note: 'liability insurance Jan: 69.59 € (yearly fee) TODO: add Mich\'s liability insurance too', amount: 69.59},
          {ower: 'jan', owee: 'nlnet', month: 6, note: 'received bank transfer 2 Mar', amount: 3000},
          {ower: 'compCampPub', owee: 'jan', month: 6, note: 'sending two shirts (March 7)', amount: 4.90},
          {ower: 'travAccConf', owee: 'jan', month: 6, note: 'bus tickets (5.00+2.70) getting into Amsterdam (hitchhiked there, March 7)', amount: 5+2.70},
          {ower: 'compCampPub', owee: 'jan', month: 6, note: 'printing Unhosted readers for Unlike Us conf attendees (March 9)', amount: 7.95},
          {ower: 'travAccConf', owee: 'jan', month: 6, note: '(3*2.70) getting to the Unlike Us conf venue (March 9–10)', amount: 3*2.70},
          {ower: 'travAccConf', owee: 'jan', month: 6, note: 'Unlike Us Amsterdam train back (March 11)', amount: 79},
          {ower: 'deskJan', owee: 'jan', month: 6, note: '10-day flex ticket Coworking0711 (March 15)', amount: 149},
          {ower: 'travAccConf', owee: 'jan', month: 6, note: '', amount: 3*2.70},
          {ower: 'healthJan', owee: 'jan', month: 6, note: 'health insurance feb (March 15)', amount: 221.15},
          {ower: 'compCampPub', owee: 'jan', month: 6, note: 'sending another shirt (March 17)', amount: 3.45},
          {ower: 'compCampPub', owee: 'jan', month: 6, note: 'one thousand new stickers from Flyeralarm (March 22)', amount: 54.61},
          {ower: 'healthJan', owee: 'jan', month: 7, note: 'health insurance mar (April 15)', amount: 221.15},
          {ower: 'healthJan', owee: 'jan', month: 8, note: 'health insurance apr (May 15)', amount: 221.15},
          {ower: 'healthJan', owee: 'jan', month: 9, note: 'health insurance may (June 15)', amount: 221.15},
          {ower: 'healthJan', owee: 'jan', month: 10, note: 'health insurance june (July 15)', amount: 221.15},
          {ower: 'healthJan', owee: 'jan', month: 11, note: 'health insurance july (Aug 15)', amount: 221.15},
          {ower: 'healthJan', owee: 'jan', month: 11, note: 'health insurance aug (Sep 15)', amount: 221.15}
          //0:sep 1:oct 2:nov 3:dec 4:jan 5:feb 6:mar 7:apr 
          //{ower: 'hosting', owee: 'michiel', month: 5, note: '', amount: },
        ];
        for(var i=0; i < 12; i++) {
          declarations.push({ower: 'liveMich', owee: 'michiel', month: i, note: 'living expenses Michiel (based on Berlin)', amount: 1000});
          declarations.push({ower: 'liveJan', owee: 'jan', month: i, note: 'living expenses Jan (based on '+(i>8?'living outside ':'')+'Berlin)', amount: (i>8?1500:1000)});
        }
        //predict nlnet payments:
        declarations.push({ower: 'michiel', owee: 'nlnet', month: 8, note: 'predicted payment milestone D', amount: 2500});
        declarations.push({ower: 'jan', owee: 'nlnet', month: 8, note: 'predicted payment milestone D', amount: 2500});
        declarations.push({ower: 'michiel', owee: 'nlnet', month: 10, note: 'predicted payment milestone E', amount: 2500});
        declarations.push({ower: 'jan', owee: 'nlnet', month: 10, note: 'predicted payment milestone E', amount: 2500});
        declarations.push({ower: 'michiel', owee: 'nlnet', month: 11, note: 'predicted payment milestone F', amount: 2500});
        declarations.push({ower: 'jan', owee: 'nlnet', month: 11, note: 'predicted payment milestone F', amount: 2500});
        return declarations;
      }
      var data = {};
      function simulateMessage(from, to, msg) {
        if(!data[from]) {
          data[from] = {in: {}, out: {}};
        }
        if(!data[to]) {
          data[to] = {in: {}, out: {}};
        }
        if(!data[from].out[to]) {
          data[from].out[to]=[];
        }
        if(!data[to].in[from]) {
          data[to].in[from]=[];
        }
        data[from].out[to].push(msg);
        data[to].in[from].push(msg);
      }
      function simulateMessages() {
        var monthName = ['Sep11', 'Oct11', 'Nov11', 'Dec11', 'Jan12', 'Feb12', 'Mar12', 'Apr12', 'May12', 'Jun12', 'Jul12', 'Aug12'];
        var budgets = genBudgets();
        for(var i in budgets) {
          for(var j in budgets[i]) {
            simulateMessage('budget@unhosted.org', j+'@unhosted.org', JSON.stringify({
              subject: 'budget assignment',
              recipients: [j+'@unhosted.org'],
              body: 'The board of Unhosted e.V. hereby confirm that we have set the "'+j+'" budget for '+monthName[i]
              +' to '+budgets[i][j]+' euros. This doesn\'t mean we have to spend that money. '
              +'If we do spend this money, then we can use the attached IOU to route the payment. '
              +'If we spend more than the budget on '+j+' during that '+monthName[i]+', then we have to think why that was, and issue a separate decision with its '
              +'own IOU to route the money.',
              IOU: {
                ower: 'budget@unhosted.org',
                owee: j+'@unhosted.org',
                amount: budgets[i][j],
                currency: 'EUR',
                note: budgets[i][j].note,
                signatures: ['The general meeting of Unhosted e.V, in the #unhosted IRC channel on freenode, 9 September 2011.']
              }
            }));
          }
        }
        var declarations = getDeclarations();
        for(var i=0; i<declarations.length; i++) {
          simulateMessage(declarations[i].owee+'@unhosted.org', declarations[i].ower+'@unhosted.org', JSON.stringify({
            subject: 'declaration',
            recipients: [declarations[i].ower+'@unhosted.org'],
            body: 'Please reimburse me ('+declarations[i].owee+') '
              +declarations[i].amount+' euros for the following costs I made in '
              +monthName[declarations[i].month]+':'
              +declarations[i].note,
            IOU: {
              ower: declarations[i].ower+'@unhosted.org',
              owee: declarations[i].owee+'@unhosted.org',
              amount: declarations[i].amount,
              currency: 'EUR',
              note: declarations[i].note,
              signatures: [declarations[i].owee+'@unhosted.org']
            }
          }));
        }
      }
      function displayTab(person) {
        var str = '<table border="1"><tr><td>peer</td><td>note</td><td>amount</td><td>cumm</td></tr>';
        var IOUs = [];
        //scan the person's ingoing messages for attached IOUs
        for(var i in data[person].in) {
          for(var j in data[person].in[i]) {
            var msg = JSON.parse(data[person].in[i][j]);
            if(msg.IOU) {
              IOUs.push(msg.IOU);
            }
          }
        }
        //scan the person's outgoing messages for attached IOUs
        for(var i in data[person].out) {
          for(var j in data[person].out[i]) {
            var msg = JSON.parse(data[person].out[i][j]);
            if(msg.IOU) {
              IOUs.push(msg.IOU);
            }
          }
        }
        var cumm = 0;
        for(var i=0; i<IOUs.length; i++) {
          if(IOUs[i].ower == person) {
            cumm += IOUs[i].amount;
            str += '<tr><td>'+IOUs[i].owee
              +'</td><td>'+IOUs[i].note
              +'</td><td>'+IOUs[i].amount
              +'</td><td>'+cumm
              +'</td></tr>';
          } else if(IOUs[i].owee == person) {
            cumm -= IOUs[i].amount;
            str += '<tr><td>'+IOUs[i].ower
              +'</td><td>'+IOUs[i].note
              +'</td><td>'+(0-IOUs[i].amount)
              +'</td><td>'+cumm
              +'</td></tr>';
          }
        }
        str += '</table>';
        document.getElementById('output').innerHTML = str;
      }
      function onLoad() {
        simulateMessages();
        console.log(data);
        var str = '';
        for(var i in data) {
          str += '<a href="?#'+i+'" onclick="displayTab(\''+i+'\');">'+i+'</a>&nbsp;';
        }
        document.getElementById('navbar').innerHTML = str;
        if(location.hash.length) {
          displayTab(location.hash.substring(1));
        }
      }
    </script>
  </head>
  <body onload="onLoad();">
    <div id="navbar"></div>
    <div id="output"></div>
  </body>
</html>
