<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="js/sha1.js"></script>
    <script src="js/base64.js"></script>
    <script src="js/categoryCreator.js"></script>
    <script>
      function gup(name) {
        name = name.replace(/[\[]/,'\\\[').replace(/[\]]/,'\\\]');
        var regexS = '[\\?&]'+name+'=([^&#]*)';
        var regex = new RegExp(regexS);
        var results = regex.exec(window.location.href);
        if(results == null) {
          return "";
        } else {
          return results[1];
        }
      }
      function authorize(host, usr, pwd, scope, redirectUri) {
        console.log(host);
        console.log(usr);
        console.log(pwd);
        console.log(scope);
        console.log(redirectUri);
        var categories = scope.split(',');
        categoryCreator(host, usr, pwd, categories, 'myfavouritesandwich.org', function(token) {
          alert('http://localhost/rcvToken.html#access_token='+token);
        });
      }
      var debug;
      function allow() {
        var userAddress= gup('user_address');
        navigator.id.get(function(assertion) {
          if(assertion) {
            debug=assertion;
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/getPwd', true);
            xhr.onreadystatechange = function() {
              if(xhr.readyState==4) {
                if(xhr.status == 200) {
                  var credentials
                  try {
                    credentials = JSON.parse(xhr.responseText);
                  } catch(e) {
                    alert('sorry');
                  }
                  debug=credentials;
                  authorize(credentials.host, credentials.usr, credentials.pwd, gup('scope'), gup('redirect_uri'));
                } else {
                  alert('sorry');
                }
              }
            };
            xhr.send(assertion);
          } else {
            alert('no assertion');
          }
        }, {
          requiredEmail: userAddress
        });
      }
      function retry() {
        var credentials=debug;
        authorize(credentials.host, credentials.usr, credentials.pwd, gup('scope'), gup('redirect_uri'));
      }
    </script>
  </head>
  <body>
    <input type="submit" value="allow" onclick="allow();">
    <input type="submit" value="retry" onclick="retry();">
  </body>
  <script src="//browserid.org/include.js" type="text/javascript"></script>
</html>
